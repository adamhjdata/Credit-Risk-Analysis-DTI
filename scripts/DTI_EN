import sqlite3
import pandas as pd
import matplotlib.pyplot as plt

# Load the cleaned dataset
df = pd.read_csv('data/credit_data_clean.csv')
print(df.info()) 

# Create SQLite connection and upload data
conn = sqlite3.connect('credit_risk.db')
df.to_sql('loans', conn, if_exists='replace', index=False)

# SQL Query to calculate DTI and filter data
query = """
SELECT 
    loan_status,
    person_income,
    loan_amnt,
    (CAST(loan_amnt AS FLOAT) / person_income) AS calculated_dti
FROM loans
WHERE person_income > 0 
  AND person_age < 100
"""

df_result = pd.read_sql_query(query, conn)

# Visualization settings
plt.style.use('ggplot')
fig, ax = plt.subplots(figsize=(10, 6))

# Plotting histograms for Repaid (0) and Default (1)
for status in [0, 1]:
    subset = df_result[df_result['loan_status'] == status]
    label = 'Repaid' if status == 0 else 'Default'
    ax.hist(subset['calculated_dti'], bins=30, alpha=0.5, label=label, density=True)

# Graph labels and title
ax.set_title('DTI Ratio vs. Loan Repayment Status')
ax.set_xlabel('DTI (Loan amount / Annual income)')
ax.set_ylabel('Density')
ax.legend()

# Save the output
plt.savefig('outputs/dti_distribution.png')
plt.show()